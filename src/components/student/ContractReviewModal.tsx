import React, { useState } from 'react';
import { useForm } from 'react-hook-form';
import { motion } from 'framer-motion';
import {
  XMarkIcon,
  CalendarIcon,
  ClockIcon,
  MapPinIcon,
  VideoCameraIcon,
  DocumentCheckIcon,
  ExclamationTriangleIcon,
  ChatBubbleLeftEllipsisIcon
} from '@heroicons/react/24/outline';

import { useContractStore } from '../../store/contract.store';
import { Contract, StudentContractResponse } from '../../types/contract.types';

interface ContractReviewModalProps {
  contract: Contract;
  onClose: () => void;
  onSuccess: () => void;
}

interface ResponseFormData {
  action: 'APPROVE' | 'REJECT' | 'REQUEST_CHANGES';
  message?: string;
  requestedChanges?: string;
}

const WEEKDAYS = [
  { value: 0, label: 'Ch·ªß nh·∫≠t' },
  { value: 1, label: 'Th·ª© 2' },
  { value: 2, label: 'Th·ª© 3' },
  { value: 3, label: 'Th·ª© 4' },
  { value: 4, label: 'Th·ª© 5' },
  { value: 5, label: 'Th·ª© 6' },
  { value: 6, label: 'Th·ª© 7' }
];\n\nconst ContractReviewModal: React.FC<ContractReviewModalProps> = ({\n  contract,\n  onClose,\n  onSuccess\n}) => {\n  const { respondToContract, isRespondingToContract } = useContractStore();\n  const [selectedAction, setSelectedAction] = useState<'APPROVE' | 'REJECT' | 'REQUEST_CHANGES' | null>(null);\n\n  const {\n    register,\n    handleSubmit,\n    watch,\n    formState: { errors }\n  } = useForm<ResponseFormData>();\n\n  const watchMessage = watch('message');\n  const watchRequestedChanges = watch('requestedChanges');\n\n  const onSubmit = async (data: ResponseFormData) => {\n    if (!selectedAction) return;\n\n    try {\n      const responseData: StudentContractResponse = {\n        action: selectedAction,\n        message: data.message,\n        requestedChanges: selectedAction === 'REQUEST_CHANGES' ? data.requestedChanges : undefined\n      };\n\n      await respondToContract(contract.id, responseData);\n      onSuccess();\n    } catch (error) {\n      // Error handled in store\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('vi-VN', {\n      style: 'currency',\n      currency: 'VND'\n    }).format(amount);\n  };\n\n  const getDaysOfWeekText = () => {\n    return contract.schedule.dayOfWeek\n      .map(day => WEEKDAYS.find(w => w.value === day)?.label)\n      .filter(Boolean)\n      .join(', ');\n  };\n\n  const getExpiryTimeRemaining = () => {\n    const now = new Date();\n    const expiry = new Date(contract.expiresAt);\n    const diffMs = expiry.getTime() - now.getTime();\n    \n    if (diffMs <= 0) return 'ƒê√£ h·∫øt h·∫°n';\n    \n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n    const diffDays = Math.floor(diffHours / 24);\n    \n    if (diffDays > 0) {\n      return `${diffDays} ng√†y ${diffHours % 24} gi·ªù`;\n    }\n    return `${diffHours} gi·ªù`;\n  };\n\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\"\n    >\n      <motion.div\n        initial={{ scale: 0.95, opacity: 0 }}\n        animate={{ scale: 1, opacity: 1 }}\n        exit={{ scale: 0.95, opacity: 0 }}\n        className=\"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\"\n      >\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-6 border-b border-gray-200\">\n          <div>\n            <h3 className=\"text-xl font-semibold text-gray-900\">\n              Xem x√©t h·ª£p ƒë·ªìng\n            </h3>\n            <p className=\"text-sm text-gray-600 mt-1\">\n              T·ª´ gia s∆∞: {contract.tutor?.full_name}\n            </p>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-400 hover:text-gray-600 transition-colors\"\n          >\n            <XMarkIcon className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        <div className=\"p-6\">\n          {/* Expiry Warning */}\n          <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6\">\n            <div className=\"flex items-center space-x-2\">\n              <ExclamationTriangleIcon className=\"w-5 h-5 text-amber-600\" />\n              <span className=\"font-medium text-amber-900\">Th·ªùi h·∫°n ph√™ duy·ªát</span>\n            </div>\n            <p className=\"text-sm text-amber-800 mt-1\">\n              H·ª£p ƒë·ªìng s·∫Ω h·∫øt h·∫°n sau: <strong>{getExpiryTimeRemaining()}</strong>\n            </p>\n          </div>\n\n          {/* Contract Details */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6\">\n            {/* Basic Info */}\n            <div className=\"space-y-4\">\n              <h4 className=\"text-lg font-medium text-gray-900 flex items-center space-x-2\">\n                <DocumentCheckIcon className=\"w-5 h-5\" />\n                <span>Th√¥ng tin h·ª£p ƒë·ªìng</span>\n              </h4>\n              \n              <div className=\"space-y-3\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700\">T√™n h·ª£p ƒë·ªìng</label>\n                  <p className=\"mt-1 text-sm text-gray-900 font-medium\">{contract.title}</p>\n                </div>\n                \n                {contract.description && (\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">M√¥ t·∫£</label>\n                    <p className=\"mt-1 text-sm text-gray-900\">{contract.description}</p>\n                  </div>\n                )}\n                \n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">T·ªïng s·ªë bu·ªïi</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">{contract.totalSessions} bu·ªïi</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">Th·ªùi l∆∞·ª£ng/bu·ªïi</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">{contract.sessionDuration} ph√∫t</p>\n                  </div>\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">Gi√°/bu·ªïi</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium text-green-600\">\n                      {formatCurrency(contract.pricePerSession)}\n                    </p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">T·ªïng h·ªçc ph√≠</label>\n                    <p className=\"mt-1 text-lg text-gray-900 font-bold text-green-600\">\n                      {formatCurrency(contract.totalAmount)}\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Schedule & Location */}\n            <div className=\"space-y-4\">\n              <h4 className=\"text-lg font-medium text-gray-900 flex items-center space-x-2\">\n                <CalendarIcon className=\"w-5 h-5\" />\n                <span>L·ªãch h·ªçc & ƒê·ªãa ƒëi·ªÉm</span>\n              </h4>\n              \n              <div className=\"space-y-3\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700\">Ng√†y h·ªçc</label>\n                  <p className=\"mt-1 text-sm text-gray-900 font-medium\">{getDaysOfWeekText()}</p>\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">Gi·ªù b·∫Øt ƒë·∫ßu</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">{contract.schedule.startTime}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">Gi·ªù k·∫øt th√∫c</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">{contract.schedule.endTime}</p>\n                  </div>\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">Ng√†y b·∫Øt ƒë·∫ßu</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">\n                      {new Date(contract.startDate).toLocaleDateString('vi-VN')}\n                    </p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">D·ª± ki·∫øn k·∫øt th√∫c</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">\n                      {new Date(contract.expectedEndDate).toLocaleDateString('vi-VN')}\n                    </p>\n                  </div>\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700\">H√¨nh th·ª©c h·ªçc</label>\n                  <div className=\"mt-1 flex items-center space-x-2\">\n                    {contract.learningMode === 'ONLINE' ? (\n                      <>\n                        <VideoCameraIcon className=\"w-4 h-4 text-blue-600\" />\n                        <span className=\"text-sm text-gray-900 font-medium\">Online</span>\n                      </>\n                    ) : (\n                      <>\n                        <MapPinIcon className=\"w-4 h-4 text-green-600\" />\n                        <span className=\"text-sm text-gray-900 font-medium\">Tr·ª±c ti·∫øp</span>\n                      </>\n                    )}\n                  </div>\n                </div>\n                \n                {contract.location && (\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">ƒê·ªãa ƒëi·ªÉm h·ªçc</label>\n                    <p className=\"mt-1 text-sm text-gray-900\">{contract.location.address}</p>\n                  </div>\n                )}\n                \n                {contract.onlineInfo && (\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700\">N·ªÅn t·∫£ng online</label>\n                    <p className=\"mt-1 text-sm text-gray-900 font-medium\">{contract.onlineInfo.platform}</p>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* Payment Terms */}\n          <div className=\"bg-blue-50 rounded-lg p-4 mb-6\">\n            <h4 className=\"font-medium text-blue-900 mb-2\">üí∞ ƒêi·ªÅu kho·∫£n thanh to√°n</h4>\n            <div className=\"text-sm text-blue-800\">\n              <p>\n                <strong>Ph∆∞∆°ng th·ª©c:</strong> {' '}\n                {contract.paymentTerms.paymentMethod === 'FULL_PAYMENT' ? 'Thanh to√°n m·ªôt l·∫ßn' : 'Thanh to√°n theo k·ª≥'}\n              </p>\n              {contract.paymentTerms.paymentMethod === 'INSTALLMENTS' && contract.paymentTerms.installmentPlan && (\n                <p className=\"mt-1\">\n                  <strong>K·∫ø ho·∫°ch:</strong> {contract.paymentTerms.installmentPlan.numberOfInstallments} k·ª≥, \n                  thanh to√°n ƒë·∫ßu {contract.paymentTerms.installmentPlan.firstPaymentPercentage}%\n                </p>\n              )}\n            </div>\n          </div>\n\n          {/* Response Form */}\n          <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n            {/* Action Selection */}\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-3\">\n                Quy·∫øt ƒë·ªãnh c·ªßa b·∫°n *\n              </label>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                {/* Approve */}\n                <button\n                  type=\"button\"\n                  onClick={() => setSelectedAction('APPROVE')}\n                  className={`flex items-center justify-center space-x-2 p-4 border-2 rounded-lg transition-colors ${\n                    selectedAction === 'APPROVE'\n                      ? 'border-green-500 bg-green-50 text-green-700'\n                      : 'border-gray-200 hover:border-green-300'\n                  }`}\n                >\n                  <DocumentCheckIcon className=\"w-5 h-5\" />\n                  <span className=\"font-medium\">Ph√™ duy·ªát</span>\n                </button>\n\n                {/* Request Changes */}\n                <button\n                  type=\"button\"\n                  onClick={() => setSelectedAction('REQUEST_CHANGES')}\n                  className={`flex items-center justify-center space-x-2 p-4 border-2 rounded-lg transition-colors ${\n                    selectedAction === 'REQUEST_CHANGES'\n                      ? 'border-yellow-500 bg-yellow-50 text-yellow-700'\n                      : 'border-gray-200 hover:border-yellow-300'\n                  }`}\n                >\n                  <ChatBubbleLeftEllipsisIcon className=\"w-5 h-5\" />\n                  <span className=\"font-medium\">Y√™u c·∫ßu s·ª≠a ƒë·ªïi</span>\n                </button>\n\n                {/* Reject */}\n                <button\n                  type=\"button\"\n                  onClick={() => setSelectedAction('REJECT')}\n                  className={`flex items-center justify-center space-x-2 p-4 border-2 rounded-lg transition-colors ${\n                    selectedAction === 'REJECT'\n                      ? 'border-red-500 bg-red-50 text-red-700'\n                      : 'border-gray-200 hover:border-red-300'\n                  }`}\n                >\n                  <XMarkIcon className=\"w-5 h-5\" />\n                  <span className=\"font-medium\">T·ª´ ch·ªëi</span>\n                </button>\n              </div>\n              {!selectedAction && (\n                <p className=\"mt-1 text-sm text-red-600\">Vui l√≤ng ch·ªçn m·ªôt quy·∫øt ƒë·ªãnh</p>\n              )}\n            </div>\n\n            {/* Message */}\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Tin nh·∫Øn cho gia s∆∞ (kh√¥ng b·∫Øt bu·ªôc)\n              </label>\n              <textarea\n                {...register('message', {\n                  maxLength: {\n                    value: 500,\n                    message: 'Tin nh·∫Øn kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 500 k√Ω t·ª±'\n                  }\n                })}\n                rows={3}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n                placeholder=\"Chia s·∫ª suy nghƒ© c·ªßa b·∫°n v·ªÅ h·ª£p ƒë·ªìng n√†y...\"\n              />\n              <div className=\"flex justify-between items-center mt-1\">\n                {errors.message && (\n                  <p className=\"text-sm text-red-600\">{errors.message.message}</p>\n                )}\n                <p className=\"text-xs text-gray-500 ml-auto\">\n                  {watchMessage?.length || 0}/500\n                </p>\n              </div>\n            </div>\n\n            {/* Requested Changes (only if REQUEST_CHANGES is selected) */}\n            {selectedAction === 'REQUEST_CHANGES' && (\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Nh·ªØng thay ƒë·ªïi b·∫°n mong mu·ªën *\n                </label>\n                <textarea\n                  {...register('requestedChanges', {\n                    required: selectedAction === 'REQUEST_CHANGES' ? 'Vui l√≤ng m√¥ t·∫£ nh·ªØng thay ƒë·ªïi mong mu·ªën' : false,\n                    minLength: {\n                      value: 10,\n                      message: 'M√¥ t·∫£ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±'\n                    },\n                    maxLength: {\n                      value: 1000,\n                      message: 'M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 1000 k√Ω t·ª±'\n                    }\n                  })}\n                  rows={4}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n                  placeholder=\"M√¥ t·∫£ chi ti·∫øt nh·ªØng ƒëi·ªÅu kho·∫£n b·∫°n mu·ªën thay ƒë·ªïi trong h·ª£p ƒë·ªìng...\"\n                />\n                <div className=\"flex justify-between items-center mt-1\">\n                  {errors.requestedChanges && (\n                    <p className=\"text-sm text-red-600\">{errors.requestedChanges.message}</p>\n                  )}\n                  <p className=\"text-xs text-gray-500 ml-auto\">\n                    {watchRequestedChanges?.length || 0}/1000\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {/* Actions */}\n            <div className=\"flex justify-end space-x-3 pt-6 border-t border-gray-200\">\n              <button\n                type=\"button\"\n                onClick={onClose}\n                className=\"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors\"\n                disabled={isRespondingToContract}\n              >\n                ƒê√≥ng\n              </button>\n              <button\n                type=\"submit\"\n                disabled={!selectedAction || isRespondingToContract}\n                className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n              >\n                {isRespondingToContract ? 'ƒêang x·ª≠ l√Ω...' : 'G·ª≠i ph·∫£n h·ªìi'}\n              </button>\n            </div>\n          </form>\n        </div>\n      </motion.div>\n    </motion.div>\n  );\n};\n\nexport default ContractReviewModal;